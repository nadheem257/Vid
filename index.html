<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Public Video Call</title>
<style>
  body { margin:0; background:#111; color:white; font-family:sans-serif; display:flex; flex-direction:column; align-items:center; }
  #videos { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:20px; }
  video { width:300px; border-radius:10px; background:#000; }
  #controls { margin-top:10px; }
  button { padding:10px 15px; margin:5px; font-size:16px; border:none; border-radius:8px; cursor:pointer; }
  #status { margin-top:10px; font-size:14px; color:#0f0; }
</style>
</head>
<body>

<h1>Public Video Call</h1>
<div id="videos"></div>
<div id="controls">
  <button id="muteBtn">Mute</button>
  <button id="videoBtn">Stop Video</button>
</div>
<div id="status"></div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCwSqm65CoNwPc3PiVo1T40YJM2MAcg480",
  authDomain: "server-1-9fa4f.firebaseapp.com",
  databaseURL: "https://server-1-9fa4f-default-rtdb.firebaseio.com",
  projectId: "server-1-9fa4f",
  storageBucket: "server-1-9fa4f.firebasestorage.app",
  messagingSenderId: "1019529146427",
  appId: "1:1019529146427:web:e22f6bbe1623b528f6ec1e"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const videosDiv = document.getElementById('videos');
const muteBtn = document.getElementById('muteBtn');
const videoBtn = document.getElementById('videoBtn');
const statusDiv = document.getElementById('status');

let localStream;
let peers = {}; // store RTCPeerConnections
let myId = 'user-' + Math.random().toString(36).substr(2,5);
const roomId = 'public-video-room'; // everyone joins same public room

// Get local media
async function startLocalStream() {
  localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
  const localVideo = document.createElement('video');
  localVideo.srcObject = localStream;
  localVideo.autoplay = true;
  localVideo.muted = true;
  videosDiv.appendChild(localVideo);
}
startLocalStream();

// Listen for new users
const usersRef = db.ref('video-call/' + roomId + '/users/' + myId);
usersRef.set({id:myId});
usersRef.onDisconnect().remove();

// Handle signaling messages
const signalsRef = db.ref('video-call/' + roomId + '/signals');
signalsRef.on('child_added', async snapshot => {
  const data = snapshot.val();
  if (!data || data.sender === myId) return;

  let peer;
  if (!peers[data.sender]) {
    peer = createPeerConnection(data.sender);
    peers[data.sender] = peer;
    localStream.getTracks().forEach(track => peer.addTrack(track, localStream));
  } else {
    peer = peers[data.sender];
  }

  if (data.type === 'offer') {
    await peer.setRemoteDescription(new RTCSessionDescription(data.sdp));
    const answer = await peer.createAnswer();
    await peer.setLocalDescription(answer);
    signalsRef.push({ type:'answer', sdp:answer, sender:myId, target:data.sender });
  } else if (data.type === 'answer') {
    await peer.setRemoteDescription(new RTCSessionDescription(data.sdp));
  } else if (data.type === 'ice') {
    try { await peer.addIceCandidate(new RTCIceCandidate(data.candidate)); } catch(e){console.error(e);}
  }
});

// Create peer connection
function createPeerConnection(peerId) {
  const pc = new RTCPeerConnection();

  pc.onicecandidate = e => {
    if(e.candidate) {
      signalsRef.push({ type:'ice', candidate:e.candidate, sender:myId, target:peerId });
    }
  };

  pc.ontrack = e => {
    if(document.getElementById('video-'+peerId)) return;
    const remoteVideo = document.createElement('video');
    remoteVideo.srcObject = e.streams[0];
    remoteVideo.autoplay = true;
    remoteVideo.id = 'video-' + peerId;
    videosDiv.appendChild(remoteVideo);
  };

  return pc;
}

// Detect other users
const usersListRef = db.ref('video-call/' + roomId + '/users');
usersListRef.on('value', async snapshot => {
  const val = snapshot.val() || {};
  for (let uid in val) {
    if (uid === myId) continue;
    if (!peers[uid]) {
      const peer = createPeerConnection(uid);
      peers[uid] = peer;
      localStream.getTracks().forEach(track => peer.addTrack(track, localStream));
      const offer = await peer.createOffer();
      await peer.setLocalDescription(offer);
      signalsRef.push({ type:'offer', sdp:offer, sender:myId, target:uid });
    }
  }
});

// Mute / Stop Video buttons
muteBtn.onclick = () => {
  localStream.getAudioTracks().forEach(t=>t.enabled = !t.enabled);
  muteBtn.innerText = localStream.getAudioTracks()[0].enabled ? "Mute" : "Unmute";
};
videoBtn.onclick = () => {
  localStream.getVideoTracks().forEach(t=>t.enabled = !t.enabled);
  videoBtn.innerText = localStream.getVideoTracks()[0].enabled ? "Stop Video" : "Start Video";
};
</script>
</body>
</html>
