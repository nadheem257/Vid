<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>2-Person Auto Video Call</title>
<style>
body { margin:0; display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh; background:#05050a; color:white; font-family:sans-serif;}
video { width:45%; max-width:400px; margin:10px; border:2px solid #00eaff; border-radius:12px; background:black;}
</style>
</head>
<body>

<h2>2-Person Video Call (Auto Connect)</h2>
<video id="localVideo" autoplay muted playsinline></video>
<video id="remoteVideo" autoplay playsinline></video>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyCwSqm65CoNwPc3PiVo1T40YJM2MAcg480",
  authDomain:"server-1-9fa4f.firebaseapp.com",
  databaseURL:"https://server-1-9fa4f-default-rtdb.firebaseio.com",
  projectId:"server-1-9fa4f",
  storageBucket:"server-1-9fa4f.firebasestorage.app",
  messagingSenderId:"1019529146427",
  appId:"1:1019529146427:web:e22f6bbe1623b528f6ec1e"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let localVideo = document.getElementById('localVideo');
let remoteVideo = document.getElementById('remoteVideo');
let localStream, pc;
const roomRef = db.ref("auto-call"); // single room
const candidatesRef = roomRef.child("candidates");
let isCaller = false;

const servers = { iceServers:[{urls:"stun:stun.l.google.com:19302"}] };

async function init() {
  localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  localVideo.srcObject = localStream;

  const snapshot = await roomRef.once('value');
  if(snapshot.exists() && snapshot.child("offer").exists()) {
    // Join as callee
    pc = createPeerConnection(false);
    const offer = snapshot.val().offer;
    await pc.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    await roomRef.child("answer").set(answer.toJSON());
  } else {
    // Become caller
    isCaller = true;
    pc = createPeerConnection(true);
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    await roomRef.child("offer").set(offer.toJSON());
    roomRef.child("answer").on('value', async snap => {
      const ans = snap.val();
      if(ans && !pc.currentRemoteDescription){
        await pc.setRemoteDescription(new RTCSessionDescription(ans));
      }
    });
  }

  // Listen ICE candidates
  candidatesRef.on('child_added', snap => {
    const cand = snap.val();
    if(cand) pc.addIceCandidate(new RTCIceCandidate(cand));
  });
}

function createPeerConnection(caller){
  const pc = new RTCPeerConnection(servers);
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

  pc.ontrack = e => remoteVideo.srcObject = e.streams[0];

  pc.onicecandidate = e => {
    if(e.candidate) candidatesRef.push(e.candidate.toJSON());
  };
  return pc;
}

init();
</script>
</body>
</html>
